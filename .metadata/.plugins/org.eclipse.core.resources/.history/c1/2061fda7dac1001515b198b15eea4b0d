package robot.states;

import robot.MyRobotLego;

public class StateMachine implements RobotNervousSystem 
{
	private MyRobotLego robot;
	
	public MyRobotLego getRobot() { return this.robot; }
	
	/* Available states */
	private ActiveState activeState;
	private PassiveState passiveState;
	
	public State getActiveState() { return this.activeState; }
	public void setActiveState(ActiveState newState) { this.activeState = newState; }		// Forces an active state. Use with caution
	public State getPassiveState() { return this.passiveState; }
	
	public void setPassiveState(PassiveState newState) {
		passiveState.deactivate();
		passiveState = newState;
	}
	
	public void deactivatePassiveState() {
		passiveState.deactivate();
	}
	
	/* Available scanners */
	public final static int MAX_SCANNERS = 2;												// Maximum number of available scanners
	
	private Scanner[] scanners = new Scanner[MAX_SCANNERS];
	
	public Scanner[] getScanners() { return this.scanners; }
	
	public int numberOfActiveScanners() {
		int i = 0;
		for(Scanner scanner : scanners)  i = (scanner != null) ? i++ : i;
		
		return i;
	}
	
	public boolean addScanner(Scanner newScanner) {
		int nScanners = numberOfActiveScanners();
		if(scanners.length == nScanners) return false;
		
		scanners[nScanners] = newScanner;
		
		return true;
	}
	
	public void rmScanner(int id) {
		for(Scanner scanner : scanners) {
			if(scanner.id == id) scanner = null;
		}
		
		for(int i = 0; i < scanners.length; i++) {
			if(scanners[i] == null && (i < scanners.length - 1)) {
				scanners[i] = scanners[i + 1];
			}
		}
	}
	
	/* Handles events generated by each scanner */
	@Override
	public void ObjectDetected(ActiveState newState) {
		if(passiveState != null) {
			passiveState.pause();
		}
		if(activeState == null) {
			activeState = newState;
		} else if(newState.weight > activeState.weight) {									// If the new state's has more priority than the current state set it
			activeState.deactivate();														// Deactivate the active state
			activeState = newState;															// Set the new active state
		}
	}
	
	@Override
	public void ObjectIsGone() {
		activeState.deactivate();
		activeState = null;
		
		if(passiveState != null) {
			passiveState.unpause();
		}
	}
}
