package robot.states;

import robot.MyRobotLego;

public class StateMachine implements RobotNervousSystem 
{
	private MyRobotLego robot;
	
	public StateMachine(MyRobotLego myRobotLego) {
		this.robot = myRobotLego;
	}
	
	public MyRobotLego getRobot() { return this.robot; }
	
	/* Available states */
	private ActiveState activeState;
	private PassiveState passiveState;
	
	public int getActiveState() { return existsActiveState() ? this.activeState.id : 0; }
	public int getPassiveState() { return existsPassiveState() ? this.passiveState.id : 0; }
	
	public boolean existsPassiveState() { return this.passiveState != null ? true : false; }
	public boolean existsActiveState() { return this.activeState != null ? true : false; }
	
	public void setActiveState(ActiveState newState) { 
		deactivateActiveState();
		pausePassiveState();
		activeState = newState;
		activeState.execute();
		
		synchronized(robot) { robot.notifyAll(); }
	}
	
	public void deactivateActiveState() {
		if(existsActiveState()) {
			activeState.deactivate();
			activeState = null;
		}
	}
	
	public void setPassiveState(PassiveState newState) {
		deactivatePassiveState();
		passiveState = newState;
	}
	
	public void deactivatePassiveState() {
		if(!existsPassiveState()) { return; }

		passiveState.deactivate();
		passiveState = null;

	}
	
	public void pausePassiveState() {
		if(existsPassiveState() && !passiveState.isPaused()) {
			passiveState.pause();
		}
	}
	
	public boolean unpausePassiveState() {
		if(!existsPassiveState()) return false;
		
		passiveState.unpause();
		return true;
	}
	
	/* Available scanners */
	public final static int MAX_SCANNERS = 2;												// Maximum number of available scanners
	
	private Scanner[] scanners = new Scanner[MAX_SCANNERS];
	
	public Scanner[] getScanners() { return this.scanners; }
	
	public int numberOfActiveScanners() {
		int i = 0;
		for(Scanner scanner : scanners) { i = (scanner != null) ? i++ : i; }
		
		return i;
	}
	
	public boolean addScanner(Scanner newScanner) {
		int nScanners = numberOfActiveScanners();
		if(scanners.length == nScanners) { return false; }
		
		scanners[nScanners] = newScanner;
		
		return true;
	}
	
	public void rmScanner(int id) {
		for(Scanner scanner : scanners) {
			if(scanner.id == id) { scanner = null; }
		}
		
		for(int i = 0; i < scanners.length; i++) {
			if(scanners[i] == null && (i < scanners.length - 1)) {
				scanners[i] = scanners[i + 1];
			}
		}
	}
	
	/* Handles events generated by each scanner */
	@Override
	public void ObjectDetected(ActiveState newState) {
		if(!existsActiveState() || (existsPassiveState() && newState.weight > activeState.weight)) {

			setActiveState(newState);
		}
	}
	
	@Override
	public void ObjectIsGone() {
		deactivateActiveState();
		unpausePassiveState();
	}
}
